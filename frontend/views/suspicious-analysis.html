<!DOCTYPE html>
<html>
  <head>
    <title>Suspicious Answer Analysis</title>
    <link rel="stylesheet" href="/css/style.css" />
    <!-- Load D3.js first -->
    <script src="https://d3js.org/d3.v7.min.js" onerror="console.error('Failed to load D3.js')"></script>
    <!-- Load venn.js after D3.js -->
    <script src="https://cdn.jsdelivr.net/npm/venn.js@0.2.1/build/venn.min.js" onerror="console.error('Failed to load venn.js')"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js" onerror="console.error('Failed to load Chart.js')"></script>
    <style>
      .analysis-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .visualization-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: 400px;
      }

      .venn-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: 400px;
      }

      .student-selector {
        margin-bottom: 20px;
      }

      .student-selector select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 200px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #6c757d;
      }

      .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }

      .venntooltip {
        position: absolute;
        text-align: center;
        width: 128px;
        height: auto;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px;
        border: 0px;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
      }

      #vennDiagram {
        width: 100%;
        height: 400px;
        position: relative;
      }

      .venn-circle {
        fill-opacity: 0.2;
        stroke-width: 2;
        stroke-opacity: 0.5;
        stroke: #000;
      }

      .venn-intersection {
        fill-opacity: 0.2;
        stroke-width: 2;
        stroke-opacity: 0.5;
        stroke: #000;
      }

      .venn-label {
        font-size: 12px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="analysis-container">
      <h1>Suspicious Answer Analysis</h1>

      <div class="student-selector">
        <select id="studentSelect" onchange="loadStudentAnalysis()">
          <option value="">Select a student...</option>
        </select>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <div id="analysisContent" style="display: none">
        <div class="visualization-grid">
          <div class="venn-container">
            <h3>Suspicious Answer Distribution</h3>
            <div id="vennDiagram"></div>
          </div>
          <div class="chart-container">
            <h3>Question Category Distribution</h3>
            <canvas id="categoryChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>Time Distribution</h3>
            <canvas id="timeChart"></canvas>
          </div>
        </div>
      </div>

      <div id="loadingMessage" class="loading">
        Select a student to view analysis...
      </div>
    </div>

    <script>
      let categoryChart = null;
      let timeChart = null;
      let librariesLoaded = {
        d3: false,
        venn: false,
        chart: false
      };

      function checkLibrariesLoaded() {
        return new Promise((resolve, reject) => {
          const checkInterval = setInterval(() => {
            // Check if all libraries are loaded
            librariesLoaded.d3 = typeof d3 !== "undefined";
            librariesLoaded.venn = typeof venn !== "undefined";
            librariesLoaded.chart = typeof Chart !== "undefined";

            console.log("Library loading status:", librariesLoaded);

            if (librariesLoaded.d3 && librariesLoaded.chart) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);

          // Timeout after 10 seconds
          setTimeout(() => {
            clearInterval(checkInterval);
            if (!librariesLoaded.d3 || !librariesLoaded.chart) {
              reject(new Error("Libraries failed to load within timeout"));
            }
          }, 10000);
        });
      }

      // Load student list
      async function loadStudentList() {
        try {
          console.log("Loading student list...");
          console.log("Current URL:", window.location.href);
          console.log("Making request to: /api/timing-analysis/students");
          
          const response = await fetch("/api/timing-analysis/students", {
            method: 'GET',
            credentials: 'include', // Include cookies for session
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log("Response data:", data);

          if (data.success) {
            console.log("Student list loaded:", data.students);
            const select = document.getElementById("studentSelect");
            // Clear existing options except the first one
            while (select.options.length > 1) {
              select.remove(1);
            }

            if (data.students && data.students.length > 0) {
              data.students.forEach((student) => {
                const option = document.createElement("option");
                option.value = student.id;
                option.textContent = student.username;
                select.appendChild(option);
              });
              console.log(`Added ${data.students.length} students to dropdown`);
            } else {
              console.warn("No students found in the response");
              showError("No students found in the database. Make sure students have taken tests and timing data exists.");
            }
          } else {
            console.error("Failed to load student list:", data.message);
            showError(data.message || "Failed to load student list");
          }
        } catch (error) {
          console.error("Error loading student list:", error);
          showError("Failed to load student list: " + error.message);
        }
      }

      // Load analysis for selected student
      async function loadStudentAnalysis() {
        const studentId = document.getElementById("studentSelect").value;
        if (!studentId) {
          document.getElementById("analysisContent").style.display = "none";
          document.getElementById("loadingMessage").style.display = "block";
          return;
        }

        document.getElementById("loadingMessage").textContent =
          "Loading analysis...";
        document.getElementById("analysisContent").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";

        try {
          console.log("Loading analysis for student:", studentId);
          const response = await fetch(
            `/api/timing-analysis/student-visualization/${studentId}`
          );
          const data = await response.json();

          if (data.success) {
            console.log("Analysis data loaded:", data);

            if (!data.vennData || !data.vennData.total_answers) {
              console.warn("No Venn diagram data available for this student");
              showError("No analysis data available for this student");
              return;
            }

            document.getElementById("loadingMessage").style.display = "none";
            document.getElementById("analysisContent").style.display = "block";

            // Update Venn diagram
            await updateVennDiagram(data.vennData);

            // Update pie charts
            if (data.categoryData && data.categoryData.length > 0) {
              updateCategoryChart(data.categoryData);
            }
            if (data.timeDistribution && data.timeDistribution.length > 0) {
              updateTimeChart(data.timeDistribution);
            }
          } else {
            console.error("Failed to load analysis data:", data.message);
            showError(data.message || "Failed to load analysis data");
          }
        } catch (error) {
          console.error("Error loading analysis:", error);
          showError("Failed to load analysis data: " + error.message);
        }
      }

      // Wait for all scripts to load before initializing
      window.addEventListener("load", async function () {
        try {
          await checkLibrariesLoaded();
          console.log("Libraries loaded successfully:", librariesLoaded);
          loadStudentList();
        } catch (error) {
          console.error("Failed to load libraries:", error);
          showError(
            "Some visualization libraries failed to load. Basic charts will still work. Please refresh the page if you need full functionality."
          );
          // Still try to load student list even if some libraries failed
          loadStudentList();
        }
      });

      // Update Venn diagram
      async function updateVennDiagram(data) {
        try {
          console.log("Updating Venn diagram with data:", data);

          // Clear previous diagram
          const vennContainer = document.getElementById("vennDiagram");
          vennContainer.innerHTML = "";

          // Calculate total answers for percentage
          const total = data.total_answers || 0;
          console.log("Total answers:", total);

          if (total === 0) {
            showError("No answer data available for this student");
            return;
          }

          // Calculate percentages for each category
          const highlySuspiciousPercent =
            total > 0
              ? (((data.highly_suspicious || 0) / total) * 100).toFixed(1)
              : 0;
          const moderatelySuspiciousPercent =
            total > 0
              ? (((data.moderately_suspicious || 0) / total) * 100).toFixed(1)
              : 0;
          const normalPercent =
            total > 0 ? (((data.normal || 0) / total) * 100).toFixed(1) : 0;

          console.log("Percentages:", {
            highlySuspicious: highlySuspiciousPercent,
            moderatelySuspicious: moderatelySuspiciousPercent,
            normal: normalPercent,
          });

          // Try to use venn.js if available, otherwise create a simple bar chart
          if (librariesLoaded.venn && typeof venn !== "undefined" && venn.VennDiagram) {
            try {
              // Create Venn diagram data - simplified for better compatibility
              const sets = [
                {
                  sets: ["Highly Suspicious"],
                  size: data.highly_suspicious || 0,
                  label: `Highly Suspicious (${highlySuspiciousPercent}%)`,
                },
                {
                  sets: ["Moderately Suspicious"],
                  size: data.moderately_suspicious || 0,
                  label: `Moderately Suspicious (${moderatelySuspiciousPercent}%)`,
                },
                {
                  sets: ["Normal"],
                  size: data.normal || 0,
                  label: `Normal (${normalPercent}%)`,
                }
              ];

              console.log("Venn diagram sets:", sets);

              // Create SVG container
              const width = 600;
              const height = 400;
              const svg = d3
                .select("#vennDiagram")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

              // Create Venn diagram
              const chart = venn.VennDiagram()
                .width(width)
                .height(height);

              // Draw the Venn diagram
              svg.datum(sets).call(chart);

              // Style the diagram
              svg
                .selectAll(".venn-circle path")
                .style("fill-opacity", 0.2)
                .style("stroke-width", 2)
                .style("stroke-opacity", 0.5)
                .style("stroke", "#000");

              svg
                .selectAll(".venn-intersection path")
                .style("fill-opacity", 0.2)
                .style("stroke-width", 2)
                .style("stroke-opacity", 0.5)
                .style("stroke", "#000");

              // Add labels
              svg
                .selectAll(".venn-circle text")
                .style("font-size", "12px")
                .style("font-weight", "bold");

              console.log("Venn diagram rendered successfully");
            } catch (vennError) {
              console.warn("Venn diagram failed, creating bar chart instead:", vennError);
              createBarChart(data, highlySuspiciousPercent, moderatelySuspiciousPercent, normalPercent);
            }
          } else {
            console.warn("venn.js not available, creating bar chart instead");
            createBarChart(data, highlySuspiciousPercent, moderatelySuspiciousPercent, normalPercent);
          }
        } catch (error) {
          console.error("Error updating Venn diagram:", error);
          showError("Failed to update Venn diagram: " + error.message);
        }
      }

      // Create a simple bar chart as fallback
      function createBarChart(data, highlySuspiciousPercent, moderatelySuspiciousPercent, normalPercent) {
        const vennContainer = document.getElementById("vennDiagram");
        vennContainer.innerHTML = "";

        // Check if D3.js is available
        if (librariesLoaded.d3 && typeof d3 !== "undefined") {
          const width = 600;
          const height = 400;
          const margin = { top: 20, right: 30, bottom: 40, left: 40 };
          const chartWidth = width - margin.left - margin.right;
          const chartHeight = height - margin.top - margin.bottom;

          const svg = d3
            .select("#vennDiagram")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

          const g = svg
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          // Data for the bar chart
          const chartData = [
            { category: "Highly Suspicious", count: data.highly_suspicious || 0, percentage: highlySuspiciousPercent, color: "#ff6b6b" },
            { category: "Moderately Suspicious", count: data.moderately_suspicious || 0, percentage: moderatelySuspiciousPercent, color: "#4ecdc4" },
            { category: "Normal", count: data.normal || 0, percentage: normalPercent, color: "#45b7d1" }
          ];

          // Scales
          const xScale = d3.scaleBand()
            .domain(chartData.map(d => d.category))
            .range([0, chartWidth])
            .padding(0.1);

          const yScale = d3.scaleLinear()
            .domain([0, d3.max(chartData, d => d.count)])
            .range([chartHeight, 0]);

          // Create bars
          g.selectAll(".bar")
            .data(chartData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => xScale(d.category))
            .attr("y", d => yScale(d.count))
            .attr("width", xScale.bandwidth())
            .attr("height", d => chartHeight - yScale(d.count))
            .attr("fill", d => d.color)
            .attr("opacity", 0.8);

          // Add labels on bars
          g.selectAll(".bar-label")
            .data(chartData)
            .enter()
            .append("text")
            .attr("class", "bar-label")
            .attr("x", d => xScale(d.category) + xScale.bandwidth() / 2)
            .attr("y", d => yScale(d.count) - 5)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold")
            .text(d => `${d.count} (${d.percentage}%)`);

          // Add x-axis
          g.append("g")
            .attr("transform", `translate(0,${chartHeight})`)
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("font-size", "10px")
            .attr("transform", "rotate(-45)")
            .attr("text-anchor", "end");

          // Add y-axis
          g.append("g")
            .call(d3.axisLeft(yScale))
            .attr("font-size", "10px");

          // Add title
          g.append("text")
            .attr("x", chartWidth / 2)
            .attr("y", -5)
            .attr("text-anchor", "middle")
            .attr("font-size", "14px")
            .attr("font-weight", "bold")
            .text("Suspicious Answer Distribution");

          console.log("D3.js bar chart rendered successfully");
        } else {
          // Fallback to simple HTML visualization
          createSimpleHTMLChart(data, highlySuspiciousPercent, moderatelySuspiciousPercent, normalPercent);
        }
      }

      // Create simple HTML-based chart when D3.js is not available
      function createSimpleHTMLChart(data, highlySuspiciousPercent, moderatelySuspiciousPercent, normalPercent) {
        const vennContainer = document.getElementById("vennDiagram");
        vennContainer.innerHTML = "";

        const chartData = [
          { category: "Highly Suspicious", count: data.highly_suspicious || 0, percentage: highlySuspiciousPercent, color: "#ff6b6b" },
          { category: "Moderately Suspicious", count: data.moderately_suspicious || 0, percentage: moderatelySuspiciousPercent, color: "#4ecdc4" },
          { category: "Normal", count: data.normal || 0, percentage: normalPercent, color: "#45b7d1" }
        ];

        const maxCount = Math.max(...chartData.map(d => d.count));
        
        const chartHTML = `
          <div style="padding: 20px;">
            <h4 style="text-align: center; margin-bottom: 20px;">Suspicious Answer Distribution</h4>
            <div style="display: flex; flex-direction: column; gap: 15px;">
              ${chartData.map(item => `
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 20px; height: 20px; background-color: ${item.color}; border-radius: 3px;"></div>
                  <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${item.category}</div>
                    <div style="background-color: #f0f0f0; border-radius: 5px; height: 20px; position: relative;">
                      <div style="background-color: ${item.color}; height: 100%; width: ${maxCount > 0 ? (item.count / maxCount) * 100 : 0}%; border-radius: 5px; transition: width 0.3s ease;"></div>
                      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: #333;">
                        ${item.count} (${item.percentage}%)
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;

        vennContainer.innerHTML = chartHTML;
        console.log("Simple HTML chart rendered successfully");
      }

      // Create simple HTML-based pie chart when Chart.js is not available
      function createSimplePieChart(data, containerId, title) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        const total = data.reduce((sum, item) => sum + (item.suspicious_count || 0), 0);
        
        if (total === 0) {
          container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">No data available</div>`;
          return;
        }

        const colors = ["#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#feca57"];
        
        const chartHTML = `
          <div style="padding: 20px;">
            <h4 style="text-align: center; margin-bottom: 20px;">${title}</h4>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              ${data.map((item, index) => {
                const percentage = total > 0 ? ((item.suspicious_count || 0) / total * 100).toFixed(1) : 0;
                return `
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; background-color: ${colors[index % colors.length]}; border-radius: 50%;"></div>
                    <div style="flex: 1;">
                      <div style="font-weight: bold;">${item.category}</div>
                      <div style="color: #666; font-size: 14px;">
                        ${item.suspicious_count || 0} suspicious out of ${item.count || 0} total (${percentage}%)
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;

        container.innerHTML = chartHTML;
        console.log("Simple pie chart rendered successfully");
      }

      // Update category distribution chart
      function updateCategoryChart(data) {
        try {
          console.log("Updating category chart with data:", data);
          
          // Check if Chart.js is available
          if (!librariesLoaded.chart || typeof Chart === "undefined") {
            console.warn("Chart.js not available, creating simple HTML chart");
            createSimplePieChart(data, "categoryChart", "Suspicious Answers by Category");
            return;
          }

          const ctx = document.getElementById("categoryChart").getContext("2d");

          // Destroy existing chart if it exists
          if (categoryChart instanceof Chart) {
            categoryChart.destroy();
          }

          // Prepare data for the chart
          const labels = data.map((item) => item.category);
          const suspiciousData = data.map((item) => item.suspicious_count);
          const totalData = data.map((item) => item.count);

          categoryChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Suspicious Answers",
                  data: suspiciousData,
                  backgroundColor: [
                    "rgba(255, 99, 132, 0.8)",
                    "rgba(54, 162, 235, 0.8)",
                    "rgba(255, 206, 86, 0.8)",
                    "rgba(75, 192, 192, 0.8)",
                    "rgba(153, 102, 255, 0.8)",
                  ],
                  borderColor: [
                    "rgba(255, 99, 132, 1)",
                    "rgba(54, 162, 235, 1)",
                    "rgba(255, 206, 86, 1)",
                    "rgba(75, 192, 192, 1)",
                    "rgba(153, 102, 255, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    font: {
                      size: 12,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed || 0;
                      const total = totalData[context.dataIndex];
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: ${value} suspicious (${percentage}%)`;
                    },
                  },
                },
                title: {
                  display: true,
                  text: "Suspicious Answers by Category",
                  font: {
                    size: 16,
                  },
                },
              },
            },
          });
          console.log("Category chart rendered successfully");
        } catch (error) {
          console.error("Error updating category chart:", error);
          showError("Failed to update category chart: " + error.message);
        }
      }

      // Update time distribution chart
      function updateTimeChart(data) {
        try {
          console.log("Updating time chart with data:", data);
          
          // Check if Chart.js is available
          if (!librariesLoaded.chart || typeof Chart === "undefined") {
            console.warn("Chart.js not available, creating simple HTML chart");
            createSimplePieChart(data, "timeChart", "Answer Time Distribution");
            return;
          }

          const ctx = document.getElementById("timeChart").getContext("2d");

          // Destroy existing chart if it exists
          if (timeChart instanceof Chart) {
            timeChart.destroy();
          }

          // Prepare data for the chart
          const labels = data.map((item) => item.time_category);
          const values = data.map((item) => item.count);
          const percentages = data.map((item) => item.percentage);

          timeChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    "rgba(255, 99, 132, 0.8)", // Highly Suspicious
                    "rgba(255, 159, 64, 0.8)", // Moderately Suspicious
                    "rgba(75, 192, 192, 0.8)", // Normal
                  ],
                  borderColor: [
                    "rgba(255, 99, 132, 1)",
                    "rgba(255, 159, 64, 1)",
                    "rgba(75, 192, 192, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    font: {
                      size: 12,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed || 0;
                      const percentage = percentages[context.dataIndex];
                      return `${label}: ${value} answers (${percentage}%)`;
                    },
                  },
                },
                title: {
                  display: true,
                  text: "Answer Time Distribution",
                  font: {
                    size: 16,
                  },
                },
              },
            },
          });
          console.log("Time chart rendered successfully");
        } catch (error) {
          console.error("Error updating time chart:", error);
          showError("Failed to update time chart: " + error.message);
        }
      }

      // Show error message
      function showError(message) {
        console.error("Error:", message);
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";
      }
    </script>
  </body>
</html>
